# services/reminder.py
import os, re, sqlite3
from datetime import datetime, timedelta
from services.session import get_session, set_session

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
REMINDERS_DB = os.getenv("REMINDERS_DB_PATH", "reminders.db")

def init_reminder_db():
    """
    ØªÙÙ†Ø´Ø¦ Ø¬Ø¯ÙˆÙ„ reminders Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§.
    ÙŠØ³ØªØ¯Ø¹ÙŠÙ‡Ø§ main.py Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ù‚Ù„Ø§Ø¹.
    """
    conn = sqlite3.connect(REMINDERS_DB)
    conn.execute("""
        CREATE TABLE IF NOT EXISTS reminders (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            sender           TEXT NOT NULL,
            type             TEXT NOT NULL,
            interval_minutes INTEGER,
            remind_at        TEXT NOT NULL,
            active           INTEGER DEFAULT 1
        );
    """)
    conn.commit(); conn.close()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Ù†ØµÙˆØµ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
MAIN_MENU_TEXT = (
    "*Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¯Ù„ÙŠÙ„ Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù‚Ø±ÙŠÙ†*\n"
    "ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¹Ù† Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©:\n\n"
    "1ï¸âƒ£ Ø­ÙƒÙˆÙ…ÙŠ ğŸ¢\n"
    "20- Ù…Ù†Ø¨Ù‘Ù‡ ğŸ“†"
)

REMINDER_MENU_TEXT = (
    "â° *Ù…Ù†Ø¨Ù‘Ù‡*\n"
    "Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªØ°ÙƒÙŠØ± Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯Ù‡:\n\n"
    "2ï¸âƒ£ Ù…ÙˆØ¹Ø¯ Ù…Ø³ØªØ´ÙÙ‰ Ø£Ùˆ Ù…Ù†Ø§Ø³Ø¨Ø©\n"
    "6ï¸âƒ£ ØªÙ†Ø¨ÙŠÙ‡Ø§ØªÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠØ©\n\n"
    "âŒ Ù„Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø£Ø±Ø³Ù„: Ø­Ø°Ù\n"
    "â†©ï¸ Ù„Ù„Ø±Ø¬ÙˆØ¹ (00) | ğŸ  Ø±Ø¦ÙŠØ³ÙŠØ© (0)"
)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def save_reminder(sender, typ, interval, remind_at):
    with sqlite3.connect(REMINDERS_DB) as conn:
        conn.execute(
            "INSERT INTO reminders (sender, type, interval_minutes, remind_at) VALUES (?,?,?,?)",
            (sender, typ, interval, remind_at)
        )

def list_user_reminders(sender):
    with sqlite3.connect(REMINDERS_DB) as conn:
        rows = conn.execute(
            "SELECT type, remind_at FROM reminders WHERE sender = ? AND active = 1",
            (sender,)
        ).fetchall()

    if not rows:
        return {"reply": "ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙŠ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.\n\nâ†©ï¸ Ù„Ù„Ø±Ø¬ÙˆØ¹ (00) | ğŸ  Ø±Ø¦ÙŠØ³ÙŠØ© (0)"}

    reply = "*ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© ØªÙ†Ø¨ÙŠÙ‡Ø§ØªÙƒ:*\n"
    for i, (typ, at) in enumerate(rows, 1):
        reply += f"{i}- Ù†ÙˆØ¹: {typ} | Ø§Ù„ØªØ§Ø±ÙŠØ®: {at}\n"
    reply += "\nâŒ Ù„Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø£Ø±Ø³Ù„: Ø­Ø°Ù\nâ†©ï¸ Ù„Ù„Ø±Ø¬ÙˆØ¹ (00) | ğŸ  Ø±Ø¦ÙŠØ³ÙŠØ© (0)"
    return {"reply": reply}

def delete_all_reminders(sender):
    with sqlite3.connect(REMINDERS_DB) as conn:
        conn.execute("UPDATE reminders SET active = 0 WHERE sender = ?", (sender,))
    return {"reply": "âœ… ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.\n\nâ†©ï¸ Ù„Ù„Ø±Ø¬ÙˆØ¹ (00) | ğŸ  Ø±Ø¦ÙŠØ³ÙŠØ© (0)"}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Ø§Ù„Ø¯Ø§Ù„Ù‘Ø© Ø§Ù„Ø±Ø¦ÙŠØ³Ù€ÙŠÙ€Ø©
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def handle(msg: str, sender: str) -> dict:
    session = get_session(sender)
    text    = msg.strip()

    # ---------- Ù…ÙØ§ØªÙŠØ­ Ø¹Ø§Ù…Ù‘Ø© ----------
    if text == "0":
        set_session(sender, None)
        return {"reply": MAIN_MENU_TEXT}

    if text == "00":
        if session and session.get("last_menu"):
            last = session["last_menu"]
            set_session(sender, {"menu": last, "last_menu": "main"})
            return handle(last, sender)
        return {"reply": MAIN_MENU_TEXT}

    if text == "Ø­Ø°Ù":
        return delete_all_reminders(sender)

    # ---------- Ø¨Ø¯ÙˆÙ† Ø¬Ù„Ø³Ø© ----------
    if session is None:
        if text == "20":
            set_session(sender, {"menu": "reminder_main", "last_menu": "main"})
            return {"reply": REMINDER_MENU_TEXT}
        return {"reply": MAIN_MENU_TEXT}

    # ---------- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø¨Ù‘Ù‡ ----------
    if session["menu"] == "reminder_main":
        if text == "2":
            set_session(sender, {"menu": "reminder_date", "last_menu": "reminder_main"})
            return {"reply": (
                "ğŸ“… Ø£Ø±Ø³Ù„ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø¨Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ ÙÙ‚Ø· :\n"
                "Ù…Ø«Ù„: 17-08-2025\n"
                "ÙˆØ³ÙŠØªÙ… ØªØ°ÙƒÙŠØ±Ùƒ Ù‚Ø¨Ù„ Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø¨ÙŠÙˆÙ… ÙˆØ§Ø­Ø¯\n\n"
                "â†©ï¸ Ù„Ù„Ø±Ø¬ÙˆØ¹ (00) | ğŸ  Ø±Ø¦ÙŠØ³ÙŠØ© (0)"
            )}
        if text == "6":
            return list_user_reminders(sender)
        return {"reply": "â†©ï¸ Ø§Ø®ØªØ± Ø±Ù‚Ù… ØµØ­ÙŠØ­ Ø£Ùˆ 'ØªÙˆÙ‚Ù'."}

    # ---------- Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® ----------
    if session["menu"] == "reminder_date":
        try:
            parts = [int(p) for p in re.split(r"[-./_\\\s]+", text) if p]
            if len(parts) != 3:
                raise ValueError
            day, month, year = parts
            if year < 100: year += 2000
            date_obj  = datetime(year, month, day)
            remind_at = (date_obj - timedelta(days=1)).strftime("%Y-%m-%d")
            save_reminder(sender, "hospital", None, remind_at)
            set_session(sender, {"menu": "reminder_main", "last_menu": "main"})
            return {"reply": f"âœ… ØªÙ… Ø¶Ø¨Ø· Ø§Ù„ØªØ°ÙƒÙŠØ±ØŒ Ø³ÙŠØªÙ… Ø§Ù„ØªØ°ÙƒÙŠØ± Ø¨ØªØ§Ø±ÙŠØ® {remind_at}\n\nâ†©ï¸ Ù„Ù„Ø±Ø¬ÙˆØ¹ (00) | ğŸ  Ø±Ø¦ÙŠØ³ÙŠØ© (0)"}
        except Exception:
            return {"reply": "â—ï¸ØµÙŠØºØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©. Ø£Ø±Ø³Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ø«Ù„: 17-08-2025\n\nâ†©ï¸ Ù„Ù„Ø±Ø¬ÙˆØ¹ (00) | ğŸ  Ø±Ø¦ÙŠØ³ÙŠØ© (0)"}

    return {"reply": MAIN_MENU_TEXT}
